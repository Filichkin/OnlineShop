# МИГРАЦИЯ НА HTTPONLY COOKIES И CSRF ЗАЩИТУ

## ДАТА: 28.11.2025

## ЧТО ИЗМЕНИЛОСЬ:

### 1. JWT ТОКЕНЫ ТЕПЕРЬ В HTTPONLY COOKIES

**ДО:**
- JWT токен возвращался в JSON response
- Клиент сохранял токен в localStorage
- XSS уязвимость - JavaScript мог получить доступ к токену

**ПОСЛЕ:**
- JWT токен устанавливается в httpOnly cookie
- JavaScript НЕ может прочитать cookie
- Защита от XSS атак

### 2. ДОБАВЛЕНА CSRF ЗАЩИТА

**Новые компоненты:**
- /backend/app/core/csrf.py - модуль CSRF защиты
- /backend/app/core/cookie_transport.py - транспорт для JWT через cookies

**Защищённые endpoints:**
- POST /orders/ - создание заказа
- DELETE /orders/{id} - отмена заказа
- PATCH /admin/orders/{id}/status - обновление статуса заказа (admin)
- PATCH /users/me - обновление профиля
- PATCH /admin/users/{id} - обновление пользователя (admin)
- POST /cart/items - добавление в корзину
- PATCH /cart/items/{id} - обновление корзины
- DELETE /cart/items/{id} - удаление из корзины
- DELETE /cart/ - очистка корзины

### 3. НОВЫЕ ENDPOINTS

**GET /csrf-token**
- Получение CSRF токена для аутентифицированного пользователя
- Требуется для выполнения защищённых операций

**POST /auth/logout**
- Выход из системы с удалением cookies
- Удаляет access_token и csrf_token cookies

### 4. ИЗМЕНЕНИЯ В КОНФИГУРАЦИИ

**Файл: /backend/app/core/config.py**

Добавлены настройки:
```python
secure_cookies: bool = False  # True в production (HTTPS only)
access_token_expire_minutes: int = 60  # Время жизни токена
```

**Для production окружения в .env добавить:**
```
SECURE_COOKIES=true
ACCESS_TOKEN_EXPIRE_MINUTES=60
```

### 5. ИЗМЕНЕНИЯ В LOGIN/REGISTER RESPONSE

**ДО:**
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbG...",
  "token_type": "bearer",
  "user": {...}
}
```

**ПОСЛЕ:**
```json
{
  "user": {...},
  "csrf_token": "abc123..."
}
```

**Важно:**
- access_token больше НЕ возвращается в JSON
- access_token устанавливается в httpOnly cookie
- csrf_token возвращается для backward compatibility

### 6. КАК РАБОТАЕТ ЗАЩИТА

**Алгоритм для state-changing операций:**

1. Клиент получает CSRF токен при login/register
2. CSRF токен сохраняется в cookie (НЕ httpOnly, чтобы JS мог читать)
3. Для POST/PUT/PATCH/DELETE запросов клиент должен:
   - Прочитать csrf_token из cookie
   - Отправить его в header `X-CSRF-Token`
4. Сервер проверяет:
   - Токен из cookie совпадает с токеном из header
   - Используется constant-time сравнение (защита от timing attacks)

**Для GET/HEAD/OPTIONS запросов CSRF проверка НЕ нужна**

### 7. ВАЖНЫЕ ПРОВЕРКИ

✅ session_id механизм НЕ затронут - работает как раньше
✅ merge_session_data работает корректно
✅ Backward compatibility - можно оставить старые клиенты (опционально)
✅ CORS настроен с allow_credentials=True

### 8. ЧТО НУЖНО ОБНОВИТЬ НА КЛИЕНТЕ

**1. Удалить работу с localStorage:**
```javascript
// УДАЛИТЬ:
localStorage.setItem('access_token', response.access_token);
localStorage.getItem('access_token');
localStorage.removeItem('access_token');
```

**2. Для CSRF защиты добавить:**
```javascript
// Функция для чтения cookie
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

// Для защищённых запросов добавлять header
const csrfToken = getCookie('csrf_token');

fetch('/api/orders/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken  // ВАЖНО!
  },
  credentials: 'include',  // Отправлять cookies
  body: JSON.stringify(orderData)
});
```

**3. Для всех API запросов добавить:**
```javascript
credentials: 'include'  // Отправлять cookies с запросами
```

**4. Logout:**
```javascript
// Вызвать logout endpoint
await fetch('/api/auth/logout', {
  method: 'POST',
  credentials: 'include'
});

// Удалить локальное состояние пользователя
```

### 9. CORS НАСТРОЙКИ

Проверить в main.py:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        'http://localhost:5173',
        'http://127.0.0.1:5173',
    ],
    allow_credentials=True,  # ✅ УЖЕ ЕСТЬ
    allow_methods=['*'],
    allow_headers=['*'],
)
```

### 10. ТЕСТИРОВАНИЕ

**1. Проверить login:**
```bash
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email_or_phone": "user@example.com", "password": "password"}' \
  -c cookies.txt
```

Проверить cookies.txt - должны быть access_token и csrf_token

**2. Проверить защищённый endpoint:**
```bash
# Прочитать CSRF токен из cookies.txt
CSRF_TOKEN=$(grep csrf_token cookies.txt | awk '{print $7}')

curl -X POST http://localhost:8000/api/orders/ \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: $CSRF_TOKEN" \
  -b cookies.txt \
  -d '{"first_name": "Test", ...}'
```

**3. Проверить logout:**
```bash
curl -X POST http://localhost:8000/api/auth/logout \
  -b cookies.txt
```

### 11. ОБРАТНАЯ СОВМЕСТИМОСТЬ

Если нужна поддержка старых клиентов:

1. В cookie_transport.py можно добавить fallback на Authorization header
2. Оставить возможность отключения CSRF для определённых endpoints
3. Использовать feature flags для постепенной миграции

### 12. PRODUCTION ЧЕКЛИСТ

Перед деплоем в production:

- [ ] Установить SECURE_COOKIES=true в .env
- [ ] Проверить что используется HTTPS
- [ ] Обновить CORS origins на production URLs
- [ ] Протестировать login/logout flow
- [ ] Протестировать CSRF защиту на всех endpoints
- [ ] Проверить что session_id merge работает
- [ ] Обновить клиентский код для работы с cookies
- [ ] Добавить monitoring для CSRF ошибок

### 13. ФАЙЛЫ ИЗМЕНЕНЫ

**Новые файлы:**
- /backend/app/core/csrf.py
- /backend/app/core/cookie_transport.py

**Изменённые файлы:**
- /backend/app/core/config.py
- /backend/app/core/auth.py
- /backend/app/core/user.py
- /backend/app/api/endpoints/user.py
- /backend/app/api/endpoints/order.py
- /backend/app/api/endpoints/cart.py

### 14. БЕЗОПАСНОСТЬ

**Преимущества:**
✅ Защита от XSS - токен в httpOnly cookie
✅ Защита от CSRF - двойная проверка токенов
✅ Constant-time comparison - защита от timing attacks
✅ Secure cookies в production (HTTPS only)
✅ SameSite=lax - дополнительная CSRF защита

**Что НЕ покрывается:**
- Защита от SQL injection (используется ORM)
- Защита от brute-force (есть rate limiting)
- Защита от session fixation (удаляется session_id при login)

### 15. ДОПОЛНИТЕЛЬНЫЕ РЕСУРСЫ

- OWASP CSRF Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html
- OWASP XSS Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
- FastAPI Security: https://fastapi.tiangolo.com/tutorial/security/

